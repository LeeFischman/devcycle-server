# Devcycle Load Test Framework

The following refers to the Load Test Framework for the Server.
The framework is written in ruby and is command line based.
A configuration file is used to configure the load test(s). Please see
`config_sample.txt` for formatting and usage.

The framework is primairly based on 2 ruby gems, [typhoeus](http://typhoeus.github.io/) and
[faraday](https://github.com/lostisland/faraday). Typhoeus is used for making parallel http requests
to simulate traffic. Faraday is a http wrapper to make it
easier to create http requests.

This can be used to simulate up to 200 concurrent http requests at a single time
based on Typhoeus. To increase that number you must run the framework
simultaneously on multiple machines.

###  SET-UP

*Framework works for ruby version 1.9.3 have not tested for other versions of ruby.*

1. `gem install typhoeus`

2. `gem install faraday`

###  Files

/Main.rb - the main file to run the system

framework/load_test.rb - contains most of the logic and processing

jsons/cpu_load.json - location_update request json to send to the server

configs/config_sample.txt - Configuration Sample w/ example format

framework/response_handler.rb - Response Handler for the Http Requests

###  Directory

framework/ - contains the logic of the framework

configs/ - contains all the config files

jsons/ - contains all json files. The json files constitute the data you are sending. You specify which json file in the config file


###  Usage

If you want to write your own configurations then include them in the configs/ directory. If you want
to write your own json then include them in the jsons/ directory. 

It is important to note that you do not need specify the full relative paths
of the config files when running the framework on the command line. The framework
will search for all config files in the configs/ directory. When specifying the json
files in the config files, you do not need to specify the full relative paths
for the json files, just the name of the file. The framework looks automatically
in the jsons/ directory for all json files. 

Sample command

`ruby Main.rb config_sample.txt`

or

`./Main.rb config_sample.txt`

### Configs and JSON files

Configs are formatted as follows:
```
URL (the connection URL)
#Requests (max 200)
JSON (the name of the JSON object to pull data from)
- (terminates the test definition)
```

Example config:
```
http://centri-pedal2.se.rit.edu/join_group/groupCode/riderId/
200
join_group.json
-
```
Main_GET.rb allows for groupCode and riderId to be specified as hooks in the URL for data to be plugged into dynamically.

A corresponding JSON object would then look like this:
```
{
	"groupCode" : "BIG1",
	"riderId" : 15
}
```

You can also use random test data by specifying the groupCode or riderId to be "random". Here is an example JSON for a randomized test:
```
{
	"groupCode" : "random",
	"groupCodeBase" : "BIG",
	"groupCodeMin" : 1,
	"groupCodeMax" : 50,
	"riderId" : "random",
	"riderIdMin" : 2,
	"riderIdMax" : 100
}
```

Random group codes are generated by combing a groupCodeBase ("BIG" in the above example) with a random number. The above JSON would result in a random selection between BIG1, BIG2, BIG3, ..., BIG50.

Random rider IDs are selected from the specified range of values.
 
### Recording and Analyzing

To look at the Server performance in real time the linux command `top` is used. When running
the load tests it is important to record the performance of the server. When you run the
load test make sure you run top on the server simultaneously in order to record the
performance of the server at the time of the tests. By using this command and
pipping the results this is achievable to analyze the data. Then after recording, 
grep the text in order to get the parameters you want then simply graph the numbers. 

The command below pipes the top command every 1 second into a text file called example.
`top -b -d 1 > example.txt`

The command below then greps for only the CPU performance numbers
`cat example.txt | grep Mem | cut -c 8-53 | nl -i 1`

The command below then greps for only the Mem performance numbers
`cat example.txt | grep Cpu | cut -c 35-39 | nl -i 1`

### Errors

You may encounter an error about a missing libcurl.dll when you attempt to run the load testing framework. Follow these steps to resolve it:

Go to this URL: http://rubyinstaller.org/downloads/

Download DevKit-tdm-32-4.5.2-20111229-1559-sfx.exe

Follow these instructions to set the devkit up on your machine: https://github.com/oneclick/rubyinstaller/wiki/Development-Kit

Go to this URL: http://www.paehl.com/open_source/?CURL_7.39.0&PHPSESSID=b155d4a69c7aa26b1fd67e7201d4fb3e

Select "Download libcurl.dll (all versions) only"

Extract the contents of the archive, copy libcurl.dll from the SSL folder, and paste it into your Ruby /bin folder (probably C:\Ruby193\bin if you're on Windows)
